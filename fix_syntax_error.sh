#!/bin/bash
# –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ –≤ ui/routes.py

cd /opt/reverse-proxy-monitor

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏..."

# –°–æ–∑–¥–∞–µ–º backup
cp backend/ui/routes.py backend/ui/routes.py.backup.syntax.$(date +%Y%m%d_%H%M%S)

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É
python3 << 'EOF'
import re

with open('backend/ui/routes.py', 'r') as f:
    content = f.read()

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—É—é —Å—Ç—Ä–æ–∫—É
# –ò—â–µ–º –±–ª–æ–∫ set_cookie –∏ –∑–∞–º–µ–Ω—è–µ–º —Ü–µ–ª–∏–∫–æ–º
pattern = r'response\.set_cookie\(\s*key="access_token",\s*value=access_token,\s*max_age=settings\.ACCESS_TOKEN_EXPIRE_MINUTES \* 60,\s*httponly=True,\s*secure=False,.*?samesite="lax".*?\)'

replacement = '''response.set_cookie(
        key="access_token",
        value=access_token,
        max_age=settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60,
        httponly=True,
        secure=False,
        samesite="lax"
    )'''

content = re.sub(pattern, replacement, content, flags=re.MULTILINE | re.DOTALL)

with open('backend/ui/routes.py', 'w') as f:
    f.write(content)

print("‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞")
EOF

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python..."
python3 -m py_compile backend/ui/routes.py

if [ $? -eq 0 ]; then
    echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞..."
    systemctl restart reverse-proxy-monitor
    
    sleep 5
    if systemctl is-active --quiet reverse-proxy-monitor; then
        echo "‚úÖ –°–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
        echo "üåê –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏: http://$(hostname -I | awk '{print $1}'):5000/"
        echo "   –õ–æ–≥–∏–Ω: admin"
        echo "   –ü–∞—Ä–æ–ª—å: admin123"
    else
        echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏"
        journalctl -u reverse-proxy-monitor --no-pager -n 10
    fi
else
    echo "‚ùå –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤—Å–µ –µ—â–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
fi